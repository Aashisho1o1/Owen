<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOG Writer - Authentication Fixes Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .test-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .test-button.danger {
            background: #ef4444;
        }
        .test-button.danger:hover {
            background: #dc2626;
        }
        .test-button.success {
            background: #10b981;
        }
        .test-button.success:hover {
            background: #059669;
        }
        .result {
            background: #f3f4f6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .result.success {
            background: #ecfdf5;
            border-left: 4px solid #10b981;
        }
        .result.error {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }
        .result.warning {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.healthy { background: #dcfce7; color: #166534; }
        .status.unhealthy { background: #fee2e2; color: #991b1b; }
        .status.unknown { background: #f3f4f6; color: #374151; }
        h1 { color: #1f2937; margin-bottom: 30px; }
        h2 { color: #374151; margin-top: 30px; }
        .clear-button {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        .clear-button:hover {
            background: #4b5563;
        }
        .test-section {
            border-left: 4px solid #3b82f6;
            padding-left: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>üîß DOG Writer - Authentication Error Debugging</h1>
    
    <div class="test-card">
        <h2>üîç Deep Authentication Error Analysis</h2>
        <p>This page tests the exact authentication error handling pipeline to identify why 401 errors are being converted to network errors.</p>
        
        <div class="test-section">
            <h3>1. Direct API Tests</h3>
            <button class="test-button" onclick="testDirectBackendConnection()">Test Direct Backend Connection</button>
            <button class="test-button" onclick="testChatWithInvalidToken()">Test Chat with Invalid Token</button>
            <button class="test-button danger" onclick="testChatWithNoToken()">Test Chat with No Token</button>
            <div id="direct-test-results"></div>
        </div>

        <div class="test-section">
            <h3>2. Frontend API Client Tests</h3>
            <button class="test-button" onclick="testFrontendApiClient()">Test Frontend API Client</button>
            <button class="test-button" onclick="testWithExpiredToken()">Test with Expired Token</button>
            <button class="test-button" onclick="testRetryLogic()">Test Retry Logic</button>
            <div id="frontend-test-results"></div>
        </div>

        <div class="test-section">
            <h3>3. Error Handler Analysis</h3>
            <button class="test-button" onclick="analyzeErrorFlow()">Analyze Error Flow</button>
            <button class="test-button" onclick="testResponseInterceptor()">Test Response Interceptor</button>
            <button class="test-button success" onclick="clearAllTests()">Clear All Results</button>
            <div id="error-analysis-results"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://backend-copy-production-95b5.up.railway.app';
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            if (!element.textContent) {
                element.className = `result ${type}`;
            }
            element.textContent += logEntry;
            element.scrollTop = element.scrollHeight;
        }

        function clearResults(elementId) {
            const element = document.getElementById(elementId);
            element.textContent = '';
            element.className = 'result';
        }

        function clearAllTests() {
            ['direct-test-results', 'frontend-test-results', 'error-analysis-results'].forEach(clearResults);
        }

        // Test 1: Direct Backend Connection
        async function testDirectBackendConnection() {
            log('direct-test-results', 'üîç Testing direct backend connection...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                const data = await response.json();
                
                log('direct-test-results', `‚úÖ Health check: ${response.status} ${response.statusText}`, 'success');
                log('direct-test-results', `üìä Backend status: ${data.status}`, 'success');
                log('direct-test-results', `üóÑÔ∏è Database: ${data.database?.status || 'unknown'}`, 'success');
                
            } catch (error) {
                log('direct-test-results', `‚ùå Health check failed: ${error.message}`, 'error');
                log('direct-test-results', `üîç Error details: ${JSON.stringify(error, null, 2)}`, 'error');
            }
        }

        // Test 2: Chat with Invalid Token
        async function testChatWithInvalidToken() {
            log('direct-test-results', 'üîç Testing chat with invalid token...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/chat/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer invalid_token_test_12345'
                    },
                    body: JSON.stringify({
                        message: 'test',
                        editor_text: 'test content',
                        author_persona: 'Ernest Hemingway',
                        help_focus: 'Dialogue Writing',
                        chat_history: [],
                        llm_provider: 'Google Gemini',
                        ai_mode: 'talk'
                    })
                });

                log('direct-test-results', `üìä Response status: ${response.status} ${response.statusText}`, 'warning');
                
                if (!response.ok) {
                    const errorData = await response.text();
                    log('direct-test-results', `üîç Error response: ${errorData}`, 'warning');
                    
                    if (response.status === 401) {
                        log('direct-test-results', '‚úÖ Backend correctly returns 401 for invalid token', 'success');
                    } else {
                        log('direct-test-results', `‚ö†Ô∏è Unexpected status code: ${response.status}`, 'warning');
                    }
                } else {
                    log('direct-test-results', '‚ùå Request succeeded when it should have failed', 'error');
                }
                
            } catch (error) {
                log('direct-test-results', `‚ùå Request failed with error: ${error.message}`, 'error');
                log('direct-test-results', `üîç Error type: ${error.constructor.name}`, 'error');
            }
        }

        // Test 3: Chat with No Token
        async function testChatWithNoToken() {
            log('direct-test-results', 'üîç Testing chat with no token...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/chat/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                        // No Authorization header
                    },
                    body: JSON.stringify({
                        message: 'test',
                        editor_text: 'test content',
                        author_persona: 'Ernest Hemingway',
                        help_focus: 'Dialogue Writing',
                        chat_history: [],
                        llm_provider: 'Google Gemini',
                        ai_mode: 'talk'
                    })
                });

                log('direct-test-results', `üìä Response status: ${response.status} ${response.statusText}`, 'warning');
                
                if (!response.ok) {
                    const errorData = await response.text();
                    log('direct-test-results', `üîç Error response: ${errorData}`, 'warning');
                } else {
                    log('direct-test-results', '‚ùå Request succeeded when it should have failed', 'error');
                }
                
            } catch (error) {
                log('direct-test-results', `‚ùå Request failed with error: ${error.message}`, 'error');
            }
        }

        // Test 4: Frontend API Client
        async function testFrontendApiClient() {
            log('frontend-test-results', 'üîç Testing frontend API client behavior...', 'info');
            
            // Store an invalid token
            localStorage.setItem('owen_access_token', 'invalid_test_token_12345');
            
            try {
                // Try to import and use the actual API client
                log('frontend-test-results', 'üì¶ Attempting to use frontend API client...', 'info');
                
                // Since we can't import modules in this context, we'll simulate the behavior
                const response = await fetch(`${API_BASE_URL}/api/chat/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('owen_access_token')}`
                    },
                    body: JSON.stringify({
                        message: 'test',
                        editor_text: 'test content',
                        author_persona: 'Ernest Hemingway',
                        help_focus: 'Dialogue Writing',
                        chat_history: [],
                        llm_provider: 'Google Gemini',
                        ai_mode: 'talk'
                    })
                });

                log('frontend-test-results', `üìä Response status: ${response.status}`, 'warning');
                
                if (response.status === 401) {
                    log('frontend-test-results', '‚úÖ Got expected 401 response', 'success');
                    
                    // Check if tokens were cleared (would happen in real API client)
                    log('frontend-test-results', 'üßπ Tokens should be cleared by API client...', 'info');
                    
                } else {
                    log('frontend-test-results', `‚ö†Ô∏è Unexpected response: ${response.status}`, 'warning');
                }
                
            } catch (error) {
                log('frontend-test-results', `‚ùå API client test failed: ${error.message}`, 'error');
                log('frontend-test-results', `üîç Error details: ${JSON.stringify({
                    name: error.name,
                    message: error.message,
                    stack: error.stack?.substring(0, 200)
                }, null, 2)}`, 'error');
            }
        }

        // Test 5: Expired Token Test
        async function testWithExpiredToken() {
            log('frontend-test-results', 'üîç Testing with expired token simulation...', 'info');
            
            // Simulate an expired but valid-format JWT token
            const expiredToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJlbWFpbCI6InRlc3RAZXhhbXBsZS5jb20iLCJleHAiOjE2MDA4NjQwMDB9.invalid_signature';
            localStorage.setItem('owen_access_token', expiredToken);
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/chat/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${expiredToken}`
                    },
                    body: JSON.stringify({
                        message: 'test with expired token',
                        editor_text: 'test content',
                        author_persona: 'Ernest Hemingway',
                        help_focus: 'Dialogue Writing',
                        chat_history: [],
                        llm_provider: 'Google Gemini',
                        ai_mode: 'talk'
                    })
                });

                log('frontend-test-results', `üìä Expired token response: ${response.status}`, 'warning');
                
                if (response.status === 401) {
                    log('frontend-test-results', '‚úÖ Backend correctly rejects expired token', 'success');
                }
                
            } catch (error) {
                log('frontend-test-results', `‚ùå Expired token test error: ${error.message}`, 'error');
            }
        }

        // Test 6: Retry Logic Analysis
        async function testRetryLogic() {
            log('frontend-test-results', 'üîç Analyzing retry logic behavior...', 'info');
            
            // Test what happens with different error types
            const testCases = [
                { status: 401, description: '401 Unauthorized' },
                { status: 403, description: '403 Forbidden' },
                { status: 404, description: '404 Not Found' },
                { status: 500, description: '500 Server Error' },
                { status: 503, description: '503 Service Unavailable' }
            ];
            
            for (const testCase of testCases) {
                try {
                    log('frontend-test-results', `üß™ Testing ${testCase.description}...`, 'info');
                    
                    // We can't easily simulate different status codes with fetch
                    // But we can document what SHOULD happen
                    if (testCase.status === 401 || testCase.status === 403 || testCase.status === 404) {
                        log('frontend-test-results', `   ‚úÖ ${testCase.status} should NOT be retried`, 'success');
                    } else if (testCase.status >= 500) {
                        log('frontend-test-results', `   üîÑ ${testCase.status} SHOULD be retried`, 'warning');
                    }
                    
                } catch (error) {
                    log('frontend-test-results', `   ‚ùå Test failed: ${error.message}`, 'error');
                }
            }
        }

        // Test 7: Error Flow Analysis
        async function analyzeErrorFlow() {
            log('error-analysis-results', 'üîç Analyzing error flow in detail...', 'info');
            
            // Check what tokens are currently stored
            const storedTokens = {
                owen_access_token: localStorage.getItem('owen_access_token'),
                owen_refresh_token: localStorage.getItem('owen_refresh_token'),
                access_token: localStorage.getItem('access_token'),
                refresh_token: localStorage.getItem('refresh_token')
            };
            
            log('error-analysis-results', 'üóÉÔ∏è Current stored tokens:', 'info');
            Object.entries(storedTokens).forEach(([key, value]) => {
                if (value) {
                    log('error-analysis-results', `   ${key}: ${value.substring(0, 20)}...`, 'warning');
                } else {
                    log('error-analysis-results', `   ${key}: null`, 'info');
                }
            });
            
            // Analyze the authentication flow
            log('error-analysis-results', 'üîÑ Expected authentication error flow:', 'info');
            log('error-analysis-results', '   1. User makes request with invalid/expired token', 'info');
            log('error-analysis-results', '   2. Backend returns 401 with {"detail": "Invalid token"}', 'info');
            log('error-analysis-results', '   3. Frontend response interceptor catches 401', 'info');
            log('error-analysis-results', '   4. Interceptor calls handleApiError()', 'info');
            log('error-analysis-results', '   5. handleApiError() creates enhanced error message', 'info');
            log('error-analysis-results', '   6. Enhanced error thrown to useChat hook', 'info');
            log('error-analysis-results', '   7. useChat displays user-friendly message', 'info');
            
            log('error-analysis-results', '‚ùå Actual problematic flow (what we see in console):', 'error');
            log('error-analysis-results', '   1. User makes request with invalid token', 'error');
            log('error-analysis-results', '   2. Something goes wrong in response interceptor', 'error');
            log('error-analysis-results', '   3. Error becomes "hasResponse: false"', 'error');
            log('error-analysis-results', '   4. Gets classified as network error', 'error');
            log('error-analysis-results', '   5. Retry logic activates', 'error');
            log('error-analysis-results', '   6. Retry fails again with same token', 'error');
            log('error-analysis-results', '   7. User sees "Network Error" instead of auth error', 'error');
        }

        // Test 8: Response Interceptor Test
        async function testResponseInterceptor() {
            log('error-analysis-results', 'üîç Testing response interceptor behavior...', 'info');
            
            // Set an invalid token for testing
            localStorage.setItem('owen_access_token', 'test_invalid_token_for_interceptor');
            
            log('error-analysis-results', 'üß™ Making request that should trigger 401...', 'info');
            
            try {
                // Make a request that will definitely fail
                const response = await fetch(`${API_BASE_URL}/api/chat/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer test_invalid_token_for_interceptor`
                    },
                    body: JSON.stringify({
                        message: 'interceptor test',
                        editor_text: 'test',
                        author_persona: 'Ernest Hemingway',
                        help_focus: 'Dialogue Writing',
                        chat_history: [],
                        llm_provider: 'Google Gemini',
                        ai_mode: 'talk'
                    })
                });

                log('error-analysis-results', `üìä Raw response status: ${response.status}`, 'warning');
                log('error-analysis-results', `üìä Response ok: ${response.ok}`, 'warning');
                log('error-analysis-results', `üìä Response type: ${response.type}`, 'warning');
                
                const responseText = await response.text();
                log('error-analysis-results', `üìÑ Response body: ${responseText}`, 'warning');
                
                if (response.status === 401) {
                    log('error-analysis-results', '‚úÖ Got expected 401 - backend is working correctly', 'success');
                    log('error-analysis-results', 'üîç Issue must be in frontend error handling', 'warning');
                }
                
            } catch (error) {
                log('error-analysis-results', `‚ùå Fetch error: ${error.message}`, 'error');
                log('error-analysis-results', `üîç Error type: ${error.constructor.name}`, 'error');
                
                // This suggests a network-level issue
                if (error.message.includes('fetch')) {
                    log('error-analysis-results', '‚ö†Ô∏è This might be a CORS or network connectivity issue', 'warning');
                }
            }
        }

        // Auto-run basic tests on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('direct-test-results', 'üöÄ Auto-running basic connectivity test...', 'info');
                testDirectBackendConnection();
            }, 1000);
        });
    </script>
</body>
</html> 
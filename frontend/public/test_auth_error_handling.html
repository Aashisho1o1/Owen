<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOG Writer - Authentication Error Testing</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #2563EB;
        }
        .test-button.danger {
            background: #EF4444;
        }
        .test-button.danger:hover {
            background: #DC2626;
        }
        .results {
            background: #F8F9FA;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #059669; }
        .error { color: #DC2626; }
        .info { color: #3B82F6; }
        .warning { color: #D97706; }
        h1 { color: #1F2937; }
        h2 { color: #374151; border-bottom: 2px solid #E5E7EB; padding-bottom: 10px; }
    </style>
</head>
<body>
    <h1>üîç DOG Writer - Authentication Error Testing</h1>
    <p>This page tests the enhanced authentication error handling fixes we just implemented.</p>

    <div class="test-section">
        <h2>üîê Authentication Debug Tools</h2>
        <button class="test-button" onclick="debugAuthentication()">Check Current Authentication</button>
        <button class="test-button" onclick="testApiConnectivity()">Test API Connectivity</button>
        <button class="test-button danger" onclick="clearAllTokens()">Clear All Tokens</button>
        <button class="test-button" onclick="runFullDiagnosis()">Run Full Diagnosis</button>
        <div id="auth-results" class="results">Click a button above to run tests...</div>
    </div>

    <div class="test-section">
        <h2>üß™ Enhanced Error Testing</h2>
        <button class="test-button" onclick="testEnhancedErrorHandling()">Test Enhanced Error Handling</button>
        <button class="test-button" onclick="test401ErrorHandling()">Test 401 Error Handling</button>
        <button class="test-button" onclick="testChatWithInvalidToken()">Test Chat with Invalid Token</button>
        <div id="error-results" class="results">Click a button above to test error handling...</div>
    </div>

    <div class="test-section">
        <h2>üìä API Client Testing</h2>
        <button class="test-button" onclick="testApiClientDirectly()">Test API Client Directly</button>
        <button class="test-button" onclick="simulateNetworkError()">Simulate Network Error</button>
        <button class="test-button" onclick="testRetryLogic()">Test Retry Logic</button>
        <div id="api-results" class="results">Click a button above to test API client...</div>
    </div>

    <script>
        // Load the debug script functions
        const API_BASE_URL = 'https://backend-copy-production-95b5.up.railway.app';

        // Set up console capture
        function logToDiv(divId, message, type = 'info') {
            const div = document.getElementById(divId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            div.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            div.scrollTop = div.scrollHeight;
        }

        // Override console for specific divs
        function captureConsoleFor(divId) {
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            
            console.log = (...args) => {
                logToDiv(divId, args.join(' '), 'info');
                originalLog.apply(console, args);
            };
            
            console.error = (...args) => {
                logToDiv(divId, args.join(' '), 'error');
                originalError.apply(console, args);
            };
            
            console.warn = (...args) => {
                logToDiv(divId, args.join(' '), 'warning');
                originalWarn.apply(console, args);
            };
            
            return () => {
                console.log = originalLog;
                console.error = originalError;
                console.warn = originalWarn;
            };
        }

        // === AUTHENTICATION DEBUG FUNCTIONS ===
        function debugAuthentication() {
            const restore = captureConsoleFor('auth-results');
            document.getElementById('auth-results').innerHTML = '';
            
            console.log('üîê === AUTHENTICATION DEBUG ===');
            
            const tokens = {
                owen_access_token: localStorage.getItem('owen_access_token'),
                owen_refresh_token: localStorage.getItem('owen_refresh_token'),
                owen_token_type: localStorage.getItem('owen_token_type'),
                owen_token_expires: localStorage.getItem('owen_token_expires'),
                access_token: localStorage.getItem('access_token'),
                refresh_token: localStorage.getItem('refresh_token'),
                token_type: localStorage.getItem('token_type'),
                expires_in: localStorage.getItem('expires_in')
            };
            
            console.log('üìã Stored tokens:');
            Object.entries(tokens).forEach(([key, value]) => {
                if (value) {
                    console.log(`‚úÖ ${key}: ${value.substring(0, 20)}...`);
                } else {
                    console.log(`‚ùå ${key}: Not found`);
                }
            });
            
            // Check token expiration
            const expiresAt = localStorage.getItem('owen_token_expires');
            if (expiresAt) {
                const expirationDate = new Date(parseInt(expiresAt) * 1000);
                const now = new Date();
                const isExpired = now > expirationDate;
                
                console.log(`üïê Token expiration: ${expirationDate.toLocaleString()}`);
                console.log(`‚è∞ Current time: ${now.toLocaleString()}`);
                console.log(`${isExpired ? '‚ùå' : '‚úÖ'} Token ${isExpired ? 'EXPIRED' : 'VALID'}`);
            }
            
            setTimeout(restore, 100);
        }

        async function testApiConnectivity() {
            const restore = captureConsoleFor('auth-results');
            
            console.log('üåê === API CONNECTIVITY TEST ===');
            
            try {
                console.log('üîç Testing health endpoint...');
                const response = await fetch(`${API_BASE_URL}/api/health`);
                const data = await response.json();
                
                if (response.ok) {
                    console.log('‚úÖ Health check successful');
                    console.log(`üìä Status: ${data.status}`);
                    console.log(`üóÑÔ∏è Database: ${data.database?.status || 'unknown'}`);
                } else {
                    console.error('‚ùå Health check failed');
                    console.error(`Status: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå Network error during health check:', error.message);
            }
            
            setTimeout(restore, 100);
        }

        function clearAllTokens() {
            const restore = captureConsoleFor('auth-results');
            
            console.log('üßπ === CLEARING ALL TOKENS ===');
            
            const tokenKeys = [
                'owen_access_token', 'owen_refresh_token', 'owen_token_type', 'owen_token_expires',
                'access_token', 'refresh_token', 'token_type', 'expires_in'
            ];
            
            tokenKeys.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    console.log(`üóëÔ∏è Removed: ${key}`);
                }
            });
            
            console.log('‚úÖ All authentication tokens cleared');
            console.log('üí° You may need to refresh the page and sign in again');
            
            setTimeout(restore, 100);
        }

        async function runFullDiagnosis() {
            const restore = captureConsoleFor('auth-results');
            document.getElementById('auth-results').innerHTML = '';
            
            console.log('üîç === RUNNING FULL DIAGNOSIS ===');
            
            // Run all tests in sequence
            debugAuthentication();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testApiConnectivity();
            
            console.log('üéØ === DIAGNOSIS COMPLETE ===');
            
            setTimeout(restore, 100);
        }

        // === ENHANCED ERROR TESTING ===
        async function testEnhancedErrorHandling() {
            const restore = captureConsoleFor('error-results');
            document.getElementById('error-results').innerHTML = '';
            
            console.log('üß™ === ENHANCED ERROR HANDLING TEST ===');
            
            try {
                console.log('üîç Testing 401 error handling...');
                
                const response = await fetch(`${API_BASE_URL}/api/chat/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer invalid_token_for_testing',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: "test",
                        editor_text: "test",
                        author_persona: "Ernest Hemingway",
                        help_focus: "Dialogue Writing",
                        chat_history: [],
                        llm_provider: "Google Gemini",
                        ai_mode: "talk"
                    })
                });
                
                console.log(`üìä Response status: ${response.status} ${response.statusText}`);
                
                if (response.status === 401) {
                    const errorData = await response.json();
                    console.log('‚úÖ 401 error correctly returned');
                    console.log(`üìù Error message: ${errorData.detail || 'No detail provided'}`);
                } else {
                    console.error('‚ùå Expected 401 but got:', response.status);
                }
                
            } catch (error) {
                console.error('‚ùå Network error during test:', error.message);
                console.error('üîç Error type:', error.name);
                console.error('üîç Error details:', error);
            }
            
            setTimeout(restore, 100);
        }

        async function test401ErrorHandling() {
            const restore = captureConsoleFor('error-results');
            
            console.log('üîê === 401 ERROR HANDLING TEST ===');
            
            // Simulate what the API client would do
            try {
                console.log('üß™ Simulating API client 401 error handling...');
                
                // This should trigger our enhanced error handling
                const testError = {
                    response: {
                        status: 401,
                        statusText: 'Unauthorized',
                        data: { detail: 'Invalid token' }
                    },
                    message: 'Request failed with status code 401'
                };
                
                console.log('‚úÖ Simulated 401 error:', testError);
                console.log('üîç This should trigger token cleanup and user-friendly message');
                
            } catch (error) {
                console.error('‚ùå Error in test:', error);
            }
            
            setTimeout(restore, 100);
        }

        async function testChatWithInvalidToken() {
            const restore = captureConsoleFor('error-results');
            
            console.log('üí¨ === CHAT WITH INVALID TOKEN TEST ===');
            
            // Set an invalid token
            localStorage.setItem('owen_access_token', 'invalid_token_for_testing');
            console.log('üîß Set invalid token in localStorage');
            
            try {
                console.log('üß™ Attempting chat request with invalid token...');
                
                const response = await fetch(`${API_BASE_URL}/api/chat/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('owen_access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: "Hello, this should fail with 401",
                        editor_text: "test content",
                        author_persona: "Ernest Hemingway",
                        help_focus: "Dialogue Writing",
                        chat_history: [],
                        llm_provider: "Google Gemini",
                        ai_mode: "talk"
                    })
                });
                
                console.log(`üìä Response: ${response.status} ${response.statusText}`);
                
                if (response.status === 401) {
                    console.log('‚úÖ 401 error correctly returned for invalid token');
                    const errorData = await response.json();
                    console.log(`üìù Server message: ${errorData.detail}`);
                } else {
                    console.error('‚ùå Unexpected response status:', response.status);
                }
                
            } catch (error) {
                console.error('‚ùå Network error:', error.message);
            }
            
            setTimeout(restore, 100);
        }

        // === API CLIENT TESTING ===
        async function testApiClientDirectly() {
            const restore = captureConsoleFor('api-results');
            document.getElementById('api-results').innerHTML = '';
            
            console.log('üîå === API CLIENT DIRECT TEST ===');
            console.log('‚ö†Ô∏è This would test the actual API client from the frontend code');
            console.log('üí° In a real test, we would import and use the API client directly');
            
            setTimeout(restore, 100);
        }

        async function simulateNetworkError() {
            const restore = captureConsoleFor('api-results');
            
            console.log('üåê === NETWORK ERROR SIMULATION ===');
            
            try {
                console.log('üß™ Attempting request to non-existent endpoint...');
                
                const response = await fetch('https://nonexistent-domain-12345.com/api/test');
                console.log('‚ùå This should not succeed');
                
            } catch (error) {
                console.log('‚úÖ Network error correctly caught:', error.message);
                console.log('üîç Error type:', error.name);
            }
            
            setTimeout(restore, 100);
        }

        async function testRetryLogic() {
            const restore = captureConsoleFor('api-results');
            
            console.log('üîÑ === RETRY LOGIC TEST ===');
            console.log('üí° This would test the retry logic in our API client');
            console.log('üß™ Our fix should prevent 401 errors from being retried');
            
            setTimeout(restore, 100);
        }

        // Initialize
        console.log('üöÄ Authentication Error Testing Page Loaded');
        console.log('üí° Use the buttons above to test different scenarios');
    </script>
</body>
</html> 